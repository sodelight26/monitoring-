server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /positions/positions.yml

clients:
  - url: http://172.17.56.221:3100/loki/api/v1/push
    # ลด overhead / ทำให้ส่งมีประสิทธิภาพขึ้น
    batchwait: 1s
    batchsize: 1048576     # 1MB
    backoff_config:
      min_period: 200ms
      max_period: 5s
      max_retries: 20
    timeout: 10s

scrape_configs:
  # =========================
  # A) Docker container logs
  # =========================
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s   # 10s -> 30s (ลดภาระชัดเจน)

    relabel_configs:
      # fixed labels (ให้ dashboard query ง่าย)
      - target_label: job
        replacement: docker
      - target_label: node
        replacement: edi-192
      - target_label: env
        replacement: office
      - target_label: project
        replacement: monitoring

      # container name -> container label
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.+)'
        target_label: container
        replacement: '$1'

      # service จาก docker-compose ถ้ามี
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        regex: '(.+)'
        target_label: service
        replacement: '$1'

      # fallback: ถ้า service ว่าง ให้ใช้ container
      - source_labels: ['service','container']
        regex: ';(.+)'
        target_label: service
        replacement: '$1'

      # service_name ให้มีเสมอ
      - source_labels: ['service']
        target_label: service_name

      # docker json log path
      - source_labels: ['__meta_docker_container_id']
        target_label: __path__
        replacement: /var/lib/docker/containers/$1/$1-json.log

      # ตัด labels meta ที่ไม่จำเป็น (ลด series / ช่วยให้ query เร็วขึ้น)
      - action: labeldrop
        regex: __meta_docker_.*

    pipeline_stages:
      - json:
          expressions:
            time: time
            log: log
            stream: stream
      - timestamp:
          source: time
          format: RFC3339Nano

      # NOTE: ตัด drop older_than ออกก่อน
      # เพราะ drop stage ทำให้ promtail ต้องเช็ค time/เงื่อนไขกับ log ทุกบรรทัด (หนักขึ้น)
      # retention ให้ไปจัดที่ Loki ทีหลังจะเหมาะกว่า

      - labels:
          stream:
      - output:
          source: log

  # =========================
  # B) Host Nginx access log (ถ้ามีจริง)
  # =========================
  - job_name: nginx_host_access
    static_configs:
      - targets: [localhost]
        labels:
          job: nginx
          env: office
          project: monitoring
          node: edi-192
          service: nginx-host
          service_name: nginx-host
          __path__: /var/log/nginx/access.log   # ระบุไฟล์ตรง ๆ อย่าใช้ *.log

    pipeline_stages:
      # parse status/method/path เพื่อทำ HTTP 4xx/5xx panel ให้ขึ้นชัวร์
      - regex:
          expression: '^(?P<remote_addr>\S+) \S+ \S+ \[[^\]]+\] "(?P<method>\S+) (?P<path>\S+) \S+" (?P<status>\d{3}) (?P<body_bytes>\d+)'
      - labels:
          status:
          method:
      - output:
          source: path

  # (optional) Nginx error log ถ้าจะดู error แยก
  - job_name: nginx_host_error
    static_configs:
      - targets: [localhost]
        labels:
          job: nginx
          env: office
          project: monitoring
          node: edi-192
          service: nginx-host
          service_name: nginx-host
          __path__: /var/log/nginx/error.log
